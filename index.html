<!DOCTYPE html>
<html lang="ja">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
    <title>Maitake Speech</title>
</head>

<body>
    <dev id="info" class="info">ブラウザが音声認識に対応しているか確認中...</dev>
    <div class="centering">
        <div class="btnParent">
            <button id="startBtn" class="startBtn" type="submit" disabled>開始</button>
            <button id="stopBtn" clss="stopBtn" type="button" disabled>停止</button>
        </div>

        <div class="signalParent">
            <div id="onstartSignal" class="onstartSignal">源</div>
            <div id="onaudiostartSignal" class="onaudiostartSignal">録</div>
            <div id="onsoundstartSignal" class="onsoundstartSignal">音</div>
            <div id="onspeechstartSignal" class="onspeechstartSignal">話</div>
        </div>
    </div>

    <div class="centering">
        <div id="result" class="result">aaa</div>
    </div>

    <div class="centering">
        <div id="resultFinished" class="resultFinished"></div>
    </div>



    <script>
        const info = document.getElementById("info");

        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");

        const onstartSignal = document.getElementById("onstartSignal");
        const onaudiostartSignal = document.getElementById("onaudiostartSignal");
        const onsoundstartSignal = document.getElementById("onsoundstartSignal");
        const onspeechstartSignal = document.getElementById("onspeechstartSignal");

        const result = document.getElementById("result");
        const resultFinished = document.getElementById("resultFinished");

        SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;

        if ("SpeechRecognition" in window) {
            info.innerText = "ブラウザは音声認識に対応しています。";
            startBtn.removeAttribute("disabled");
        } else {
            info.innerText = "ブラウザは音声認識に対応していません。";
        }

        const recognition = new SpeechRecognition();
        recognition.lang = "ja-JP";
        recognition.interimResults = true;
        recognition.continuous = true;

        let finalTranscript = "";
        let interimTranscript = "";
        recognition.onresult = (event) => {
            interimTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                let transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interimTranscript = transcript;
                }
            }
            result.innerHTML = "<span class='finalTranscript'>" + finalTranscript + "</span><span class='interimTranscript'>" + interimTranscript + "</span>";
        }

        recognition.onerror = (event) => {
            info.innerText = event.error;
        }

        recognition.onstart = () => {
            onstartSignal.style.backgroundColor = "forestgreen";
        }
        recognition.onend = () => {
            onstartSignal.style.backgroundColor = "crimson";
        }
        recognition.onaudiostart = () => {
            onaudiostartSignal.style.backgroundColor = "forestgreen";
        }
        recognition.onaudioend = () => {
            onaudiostartSignal.style.backgroundColor = "crimson";
        }
        recognition.onsoundstart = () => {
            onsoundstartSignal.style.backgroundColor = "forestgreen";
        }
        recognition.onsoundend = () => {
            //onsoundstartSignal.style.backgroundColor = "crimson";
        }
        recognition.onspeechstart = () => {
            onspeechstartSignal.style.backgroundColor = "forestgreen";
        }
        recognition.onspeechend = () => {
            onspeechstartSignal.style.backgroundColor = "crimson";
        }

        startBtn.onclick = () => {
            startBtn.setAttribute("disabled", true);
            recognition.start();
            stopBtn.removeAttribute("disabled");
        }
        stopBtn.onclick = () => {
            stopBtn.setAttribute("disabled", true);
            recognition.stop();

            let newElement = document.createElement("div");
            let newContent = document.createTextNode(result.innerText);
            newElement.appendChild(newContent);
            newElement.setAttribute("class", "resultFinishedChild");
            resultFinished.insertBefore(newElement, resultFinished.firstChild);

            finalTranscript = "";
            interimTranscript = "";
            result.innerHTML = "";

            startBtn.removeAttribute("disabled");
        }
    </script>

</body>

</html>